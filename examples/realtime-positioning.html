<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>Realtime Positioning</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src='https://api.mapbox.com/mapbox.js/v2.2.1/mapbox.js'></script>
<link href='https://api.mapbox.com/mapbox.js/v2.2.1/mapbox.css' rel='stylesheet' />
<style>
  body { margin:0; padding:0;}
  #map { position:absolute; top:0; bottom:0; width:100%; }
  #info {
      font-family: monospace, sans-serif; 
      position:absolute;
      top:0;
      right:0;
      padding: 10px;
      background-color:
      #fff; opacity: 0.5;
  }
</style>
</head>
<body>

<div id='map'></div>
<p id='info'>
    Lat: <span id=lat></span><br>
    Lng: <span id=lng></span><br>
    <span id=msg></span><br>
    Last update: <span id=last_update></span> ago<br>
    Update count: <span id=update_count></span>
</p>
<script>
    L.mapbox.accessToken = 'pk.eyJ1IjoidG9iaWUiLCJhIjoiZDM5NDhkZWFkYjRjNTRlZTc4M2M0NDQ3ZmViMjgwNDUifQ.mtE579d9kCr58yG0sfx7vA';
    var marker = null;
    var map = null;
    var last_updated;
    var update_count = 0;
    
    function onsuccess(position) {
        var coords = [position.coords.latitude, position.coords.longitude];
        updateContent(coords[0], coords[1]);
        last_updated = Date.now();
        if (map) {
            map.panTo(coords);
        } else {
            map = L.mapbox.map('map', 'mapbox.streets').setView(coords, 18);
        }
        
        if (marker) {
            marker.setLatLng(coords);
        } else {
            marker = L.circleMarker(coords)
            map.addLayer(marker);
        }
        marker.setStyle({ color: "#03f" });
    }
    
    function onerror(e) {
        updateContent(null, null, e.message);
        last_updated = Date.now();
        if (marker) marker.setStyle({ color: "#999" });
    }
    
    function updateContent(lat, lng, err) {
        document.getElementById("lat").innerHTML = lat == null ? "…" : lat;
        document.getElementById("lng").innerHTML = lng == null ? "…" : lng;
        document.getElementById("msg").innerHTML = err ? "Error: " + err : "";
        document.getElementById("update_count").innerHTML = ++update_count;
    }
    
    function updateTimer() {
        if (last_updated) {
            document.getElementById("last_update").innerHTML = displayTimeInterval(Date.now() - last_updated);
        }
        requestAnimationFrame(updateTimer);
    }
    
    function displayTimeInterval(delta) {
        return Math.floor(delta / 1000) + "." + pad(3, delta % 1000) + "s";
    }
    
    function pad(length, n) {
        n = n + "";
        while(n.length < length) {
            n = "0" + n;
        }
        return n;
    }
    
    updateTimer();
    
    navigator.geolocation.watchPosition(onsuccess, onerror, {
        enableHighAccuracy: true, 
        maximumAge: 0, 
        timeout: Infinity
    });
</script>
</body>
</html>