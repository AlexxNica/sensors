<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta charset='utf-8'>
    <title>Generic Sensor API</title>
    <script src='https://www.w3.org/Tools/respec/respec-w3c-common' async class='remove'></script>
    <script class='remove'>
        var respecConfig = {
            specStatus: "ED",
            shortName: "tbd",
            editors: [{
                name: "Rick Waldron",
                company: "jQuery Foundation",
                companyURL: "https://jquery.org/"
            },
            {
                name: "Tobie Langel",
                company: "Intel Corporation",
                companyURL: "http://intel.com/",
                w3cid: 78102
            }],
            wg: "Device APIs Group",
            wgURI: "http://www.w3.org/2009/dap/",
            wgPublicList: "public-device-apis",
            wgPatentURI:  "http://www.w3.org/2004/01/pp-impl/43696/status",
            edDraftURI: "https://w3c.github.io/sensors/",
            format: "markdown",
            noLegacyStyle: true,
            otherLinks: [{
                key: 'Repository',
                data: [{
                    value: 'We are on Github.',
                    href: 'https://github.com/w3c/sensors'
                }, {
                    value: 'Contributors',
                    href: 'https://github.com/w3c/sensors/graphs/contributors'
                }, {
                    value: 'File a bug.',
                    href: 'https://github.com/w3c/sensors/issues'
                }, {
                    value: 'Commit history.',
                    href: 'https://github.com/w3c/sensors/commits/gh-pages'
                }, {
                    value: 'Mailing list.',
                    href: 'https://lists.w3.org/Archives/Public/public-device-apis/'
                }]
            }],
            issueBase: "https://www.github.com/w3c/sensors/issues/",
            githubAPI: "https://api.github.com/repos/w3c/sensors"
        };
    </script>
  </head>
  <body>
<section id=abstract>
    This specification defines a framework for exposing sensor data to the Open Web Platform in a consistant way. It does so by defining a blueprint for writing specifications of concrete sensors along with an abstract Sensor interface that can be extended to accomodate different sensor types.
</section>

<section id=sotd>
</section>

<section id=conformance>
    Implementations that use ECMAScript to expose the APIs defined in this specification must implement them in a manner consistent with the ECMAScript Bindings defined in the Web IDL specification [[!WEBIDL]].
</section>

Use Cases
---------

<div class=issue data-number=12></div>

Security and privacy considerations
-----------------------------------

<div class=issue data-number=14></div>
<div class=issue data-number=20></div>


Dependencies
------------

The <a href="https://dom.spec.whatwg.org/#interface-eventtarget"><dfn>EventTarget</dfn></a> interface is defined in the DOM Standard [[!WHATWG-DOM]].

The <a href="http://dev.w3.org/html5/spec/webappapis.html#eventhandler"><dfn>EventHandler</dfn></a> interface represents callback used for event handlers as defined in the HTML5 specification [[!HTML5]].

The terms <a href="http://dev.w3.org/html5/spec/webappapis.html#event-handlers"><dfn>event handlers</dfn></a> and <a href="http://dev.w3.org/html5/spec/webappapis.html#event-handler-event-type"><dfn>event handler event types</dfn></a> are defined in the HTML5 specification [[!HTML5]].

<div class=issue data-number=21></div>

API
---

<div class=issue data-number=8></div>

### The <dfn>Sensors</dfn> Interface

The <a>Sensors</a> interface represents a container for a list of <a>Sensor</a> objects. It is exposed on Window and Workers as the `Window.sensors` and `WorkerGlobalScope.sensors` attribute respectively.

<pre class="idl">
[Constructor, Exposed=(Window,Worker)]
interface Sensors {
  Promise&lt;sequence&lt;Sensor&gt;&gt; matchAll(optional MatchAllOptions options);
};

partial interface Window {
  [SameObject] readonly attribute Sensors sensors;
};

partial interface WorkerGlobalScope {
  [SameObject] readonly attribute Sensors sensors;
};

dictionary MatchAllOptions {
  DOMString type;
};
</pre>

#### <dfn>Sensors.matchAll</dfn>

<div class=issue data-number=26></div>

Returns a promise which resolves to an array of <a>Sensor</a> objects representing all available local(?) sensors.

<div class=issue data-number=28></div>
<div class=issue data-number=7></div>

<pre class="example highlight">
sensors.matchAll({ type: "proximity", position: "rear" }).then(function(sensors) {
    var sensor = sensors[0];
    if (!sensor) return;
    // sensor.consructor === ProximitySensor;
    var obs = new SensorObserver(sensor, { /* ... */ });
    obs.onchange = dostuff;
});
</pre>

### The <dfn>Sensor</dfn> Interface

The `Sensor` interface is a lightweight object that represents an actual physical sensor. Concrete sensor implementation will need to subclass this.

If no `identifier` is given, the Constructor uses the identifier of the default sensor of that type. This is to the catter for the common case of having a single sensor of a given type on a device.

<pre class="example highlight javascript">

let sensor = new GeolocationSensor();
sensor.isDefault; // returns true;

</pre>

<pre class="idl">
[Constructor(optional DOMString identifier, optional SensorInit sensorInitDic), Exposed=(Window,Worker)]
interface Sensor {
    readonly attribute DOMString identifier;
    readonly attribute boolean isDefault;
    SensorObserver getObserver(optional SensorObserverOptions sensorObserverOptions);
};

dictionary SensorInit {
  boolean isDefault;
};
</pre>

#### <dfn>Sensor.identifier</dnf>

Returns the identifier of the sensor. This is an opaque DOMString.

#### <dfn>Sensor.isDefault</dnf>

Returns true if the sensor is the default sensor of that type on the device, false otherwise.

#### <dfn>Sensor.getObserver</dnf>

Returns a new <a>SensorObserver</a> object attached to this particular sensor.

<p class=ednote>Not sure if this is really necessary.</p>

<pre class="example highlight">
let obs = new GeolocationSensor().getObserver({ frequency: 60 });
obs.onchange = dostuff;

// Equivalent to:
let sensor = new GeolocationSensor();
let obs = new SensorObserver(sensor, { frequency: 60 });
obs.onchange = dostuff;
</pre>

### The <dfn>SensorObserver</dfn> Interface

The `SensorObserver` interface's role is to observe the changes in a given sensor at regular inetervals and emit events when those value change in a consumer-configurable way.

<pre class="idl">
[Constructor(Sensor sensor, optional SensorObserverOptions sensorObserverOptions), Exposed=(Window,Worker)]
interface SensorObserver : EventTarget {
  readonly attribute double frequency;
  readonly attribute boolean batch;
  readonly attribute Sensor sensor;
  readonly attribute TresholdCallback? treshold; 
  readonly attribute double timeout; 
  readonly attribute booelan wakeup; 
  readonly attribute SensorReading? value;
  readonly attribute SensorReading[]? values;
  attribute EventHandler onerror;
  attribute EventHandler onchange;
  // would that cover all cases?
  attribute EventHandler oncalibration;
  // needed?
  attribute EventHandler onconnect;
  attribute EventHandler ondisconnect;
};

dictionary SensorObserverOptions {
  double? frequency;
  boolean? batch = false;
  TresholdCallback? treshold;
  double? timeout;
};

callback TresholdCallback = boolean (SensorReading currentValue, SensorReading newValue);
</pre>

#### <dfn>SensorObserver.frequency</dfn>

<div class=issue data-number=4></div>
<div class=issue data-number=6></div>
<div class=issue data-number=23></div>

#### <dfn>SensorObserver.batch</dfn>

Returns true if <a>batch mode</a> was requested, false otherwise.

#### <dfn>SensorObserver.sensor</dfn>

Returns the related <a>Sensor</a> object.

#### <dfn>SensorObserver.treshold</dfn>

<div class=issue data-number=25></div>

#### <dfn>SensorObserver.timeout</dfn>

#### <dfn>SensorObserver.wakeup</dfn>

<div class=issue data-number=15></div>

#### <dfn>SensorObserver.value</dfn>
<div class=issue data-number=2></div>

#### <dfn>SensorObserver.values</dfn>

<div class=issue data-number=13></div>

#### <dfn>SensorObserver.onerror</dfn>

#### <dfn>SensorObserver.onchange</dfn>

#### <dfn>SensorObserver.oncalibration</dfn>

#### <dfn>SensorObserver.onconnect</dfn>

#### <dfn>SensorObserver.ondisconnect</dfn>

#### Event handlers

The following are the <a>event handlers</a> (and their corresponding <a>event handler event types</a>) that MUST be supported as attributes by the objects implementing the <a>SensorObserver</a> interface:

<table class="simple">
  <thead>
    <tr>
      <th>event handler</th>
      <th>event handler event type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong><code>onchange</code></strong></td>
      <td><code>change</code></td>
    </tr>
    <tr>
      <td><strong><code>onerror</code></strong></td>
      <td><code>error</code></td>
    </tr>
    <tr>
      <td><strong><code>oncalibration</code></strong></td>
      <td><code>calibration</code></td>
    </tr>
    <tr>
      <td><strong><code>onconnect</code></strong></td>
      <td><code>connect</code></td>
    </tr>
    <tr>
      <td><strong><code>ondisconnect</code></strong></td>
      <td><code>disconnect</code></td>
    </tr>
  </tbody>
</table>

### The <dfn>SensorReading</dfn> Interface

Represents the values of a sensor a given point in time.

<pre class="idl">
interface SensorReading {
  readonly attribute DOMTimeStamp timestamp;
  readonly attribute sensor Sensor;
};
</pre>

#### <dfn>SensorReading.timestamp</dfn>

Returns the time at which the data was <a>read from the sensor</a> in the number of milliseconds that passed since 00:00:00 UTC on 1 January 1970.

<div class=issue data-number=43></div>


#### <dfn>SensorReading.sensor</dfn>

Returns the sensor object the reading is taken from.

### Low level Sensor API

<div class=issue data-number=24></div>

Extensibility
-------------

The purpose of this section is to describe how this specification can be extended to specify concrete sensors.

It will feature precise steps on how to extend or inherit from interfaces described in this specification along with examples for two sensors, one which measures a single value and one which measures multiple ones.

<div class=issue data-number=22></div>

<section id=issue-summary></section>

<section id=acknowledgements>

Acknowledgements
----------------

The following people have greatly contributed to this specification through extensive discussions on GitHub: <span id=gh-commenters>Anssi Kostiainen, Arthur Barstow, Boris Smus, Claes Nilsson, Dave Raggett, davidmarkclements, Domenic Denicola, fhirsch, Jafar Husain, Johannes Hund, Kris Kowal, Marcos Caceres, Mats Wichmann, Matthew Podwysocki, pablochacin, Remy Sharp, Rich Tibbett, Rijubrata Bhaumik, Sean T. McBeth, smaug----, and zenparsing</span>.

We'd also like to thank <span id=gh-contributors>Anssi Kostiainen and Michael[tm] Smith</span> for their editorial input.

</section>

</body>
</html>
